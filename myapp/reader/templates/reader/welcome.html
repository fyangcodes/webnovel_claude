{% extends "reader/base.html" %}
{% load books_extras %}
{% load reader_extras %}
{% load static %}

{% block title %}Welcome{% endblock %}

{% block content %}
    <!-- Featured Books Hero Carousel -->
    {% if featured_books %}
    <section class="mt-2">
        {% include "reader/partials/hero_carousel.html" with books=featured_books section_id="featured" %}
    </section>
    {% endif %}

    <!-- Featured Genres Grouped by Section -->
    {% if featured_genres_by_section %}
    <section class="mt-2 mb-4">
        {% for section_id, section_data in featured_genres_by_section.items %}
        <div class="mb-3">
            <!-- Section Header with "All" Link -->
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h3 class="h5 mb-0">{{ section_data.section.localized_name }}</h3>
                <a href="?{% query_transform request section=section_data.section.slug %}"
                   class="btn btn-sm btn-outline-primary-custom">
                    All {{ section_data.section.localized_name }}
                </a>
            </div>

            <!-- Genre Cards for this Section -->
            <div class="genre-bar">
                {% for genre in section_data.genres %}
                <a href="{% url 'reader:genre_book_list' current_language.code genre.slug %}" class="genre-card">
                    {{ genre.localized_name }}
                </a>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </section>
    {% elif featured_genres %}
    <!-- Fallback: Flat genre list if section grouping not available -->
    <section class="mt-2 mb-4">
        <div class="genre-bar">
            <a href="{% url 'reader:book_list' current_language.code %}" class="genre-card">
                All Genres
            </a>
            {% for genre in featured_genres %}
            <a href="{% url 'reader:genre_book_list' current_language.code genre.slug %}" class="genre-card">
                {{ genre.localized_name }}
            </a>
            {% endfor %}
        </div>
    </section>
    {% endif %}

    <!-- Continue Reading -->
    <div id="continueReadingSection" style="display: none;" class="mt-2 mb-4">
        <div class="section-header">
            <h2 class="section-title">
                Continue Reading  
            </h2>
            <a href="#" class="view-all-link" id="clearHistoryLink">Clear History</a>
        </div>
        <div class="book-grid" id="continueReadingGrid">
            <!-- Books will be dynamically inserted here from localStorage -->
        </div>
    </div>

    <!-- Recently Updated Grid -->
    <section>
        {% include "reader/partials/book_grid.html" with books=recently_updated title="Recently Updated" %}
    </section>

    <!-- New Arrivals Grid -->
    <section>
        {% include "reader/partials/book_grid.html" with books=new_arrivals title="New Arrivals" %}
    </section>

    
{% endblock %}

{% block extra_js %}
<script>
// Continue Reading - Load from localStorage
(function() {
    const continueReadingSection = document.getElementById('continueReadingSection');
    const continueReadingGrid = document.getElementById('continueReadingGrid');
    const clearHistoryLink = document.getElementById('clearHistoryLink');

    function createBookCard(reading) {
        const chapterUrl = `/${reading.languageCode}/book/${reading.bookSlug}/${reading.chapterSlug}/`;
        const bookUrl = `/${reading.languageCode}/book/${reading.bookSlug}/`;
        const coverImage = reading.coverImage || '/static/reader/images/default-cover.jpg';

        return `
            <div class="book-card">
                <a href="${chapterUrl}" class="book-card-link">
                    <div class="book-card-image-wrapper">
                        <img src="${coverImage}" alt="${reading.bookTitle}" class="book-card-image">
                        <div class="book-card-genres">
                            <span class="badge bg-dark text-light position-absolute bottom-0 start-0 m-2">Chapter ${reading.chapterNumber}</span>
                        </div>
                    </div>
                    <h3 class="book-card-title">${reading.bookTitle}</h3>
                </a>
            </div>
        `;
    }

    function loadContinueReading() {
        try {
            const readingHistory = JSON.parse(localStorage.getItem('readingHistory') || '[]');

            if (readingHistory.length === 0) {
                continueReadingSection.style.display = 'none';
                return;
            }

            // Show only the first 4 books
            const recentBooks = readingHistory.slice(0, 4);

            // Generate HTML for all books
            continueReadingGrid.innerHTML = recentBooks.map(reading => createBookCard(reading)).join('');

            // Show the section
            continueReadingSection.style.display = 'block';
        } catch (error) {
            console.error('Failed to load reading history:', error);
            continueReadingSection.style.display = 'none';
        }
    }

    // Clear history handler
    if (clearHistoryLink) {
        clearHistoryLink.addEventListener('click', function(e) {
            e.preventDefault();
            if (confirm('Are you sure you want to clear your reading history?')) {
                localStorage.removeItem('readingHistory');
                continueReadingSection.style.display = 'none';
            }
        });
    }

    // Load on page load
    document.addEventListener('DOMContentLoaded', loadContinueReading);
})();
</script>
<script src="{% static 'reader/js/rotating_carousel.js' %}"></script>
{% endblock %}
