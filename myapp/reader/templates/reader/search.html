{% extends "reader/base.html" %}
{% load i18n %}
{% load books_extras %}
{% load reader_extras %}
{% load static %}

{% block title %}{% trans "Search" %}{% if search_query %}: {{ search_query }}{% endif %}{% endblock %}

{% block content %}
<!-- Search Section -->
<section class="m-2 col-lg-9">
    <!-- Search Box -->
    <div class="card mb-3">
        <div class="card-body">
            <form method="get" action="{% if section %}{% url 'reader:section_search' current_language.code section.slug %}{% endif %}">
                <div class="input-group">
                    <input type="text"
                           name="q"
                           class="form-control"
                           placeholder="{% trans 'Search by section, genre, tag, or character...' %}"
                           value="{{ search_query }}"
                           autofocus>
                    <button class="btn btn-primary-custom" type="submit">
                        <i class="fas fa-search"></i> {% trans "Search" %}
                    </button>
                </div>

                <!-- Preserve filters in search form -->
                {% if selected_genre %}
                    <input type="hidden" name="genre" value="{{ selected_genre }}">
                {% endif %}
                {% if selected_tag %}
                    <input type="hidden" name="tag" value="{{ selected_tag }}">
                {% endif %}
                {% if selected_status %}
                    <input type="hidden" name="status" value="{{ selected_status }}">
                {% endif %}
            </form>
        </div>
    </div>

    <!-- Search Metadata -->
    {% if search_query %}
    <div class="mb-3">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <p class="mb-1">
                    <strong>{% blocktrans count counter=total_results %}{{ counter }} result{% plural %}{{ counter }} results{% endblocktrans %}</strong>
                    {% if matched_keywords %}
                        {% trans "matching:" %}
                        {% for keyword in matched_keywords|slice:":5" %}
                            <span class="badge bg-light text-dark border">{{ keyword }}</span>
                        {% endfor %}
                        {% if matched_keywords|length > 5 %}
                            <span class="text-muted">{% blocktrans with more=matched_keywords|length|add:"-5" %}+{{ more }} more{% endblocktrans %}</span>
                        {% endif %}
                    {% endif %}
                </p>
                <small class="text-muted">{% blocktrans with time=search_time_ms %}Search completed in {{ time }}ms{% endblocktrans %}</small>
            </div>
            {% if search_query and section %}
            <a href="{% url 'reader:section_search' current_language.code section.slug %}" class="btn btn-sm btn-outline-secondary">
                <i class="fas fa-times"></i> {% trans "Clear Search" %}
            </a>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- Filters Card -->
    <div class="card">
        <div class="card-body">
            {% include "reader/partials/organisms/book_filters.html" with primary_genres=primary_genres primary_genre=primary_genre secondary_genres=secondary_genres %}
        </div>
    </div>
</section>

<!-- Results Section -->
<section>
    {% if books %}
        {% include "reader/partials/organisms/book_results.html" with books=books current_language=current_language is_paginated=is_paginated page_obj=page_obj %}
    {% elif search_query %}
        <!-- No Results State (only show when there was a search query) -->
        <div class="text-center py-5">
            <div class="display-3 text-muted mb-3">üîç</div>
            <h5 class="text-muted">{% blocktrans with query=search_query %}No results found for "{{ query }}"{% endblocktrans %}</h5>
            <p class="text-muted">{% trans "Try different keywords or remove some filters" %}</p>
            {% if section %}
            <a href="{% url 'reader:section_search' current_language.code section.slug %}" class="btn btn-outline-primary-custom">
                {% trans "Clear Search" %}
            </a>
            {% endif %}
        </div>
    {% else %}
        <!-- Empty Search State (when no query and no filters selected) -->
        <div class="text-center py-5">
            <div class="display-1 mb-3">üîç</div>
            <h3>{% trans "Search for Books" %}</h3>
            <p class="text-muted">
                {% trans "Search by section, genre, tag, character name, or any keyword" %}
            </p>
        </div>
    {% endif %}
</section>
{% endblock %}
