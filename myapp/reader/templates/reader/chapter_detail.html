{% extends "reader/base.html" %}
{% load books_extras %}
{% load humanize %}
{% load reader_extras %}

{% block title %}{{ chapter.title }} - {{ book.title }}{% endblock %}

{% block extra_css %}
<!-- SEO Meta Tags -->
{% seo_meta_tags 'chapter' chapter=chapter book=book language=current_language %}

<!-- Canonical URL -->
<link rel="canonical" href="{% canonical_url request %}">
{% endblock %}

{% block content %}
<!-- Reading Progress Bar -->
<div class="reading-progress-bar" id="readingProgressBar"></div>

<div class="row mt-2">
    <!-- Left Ad Space (for future use) -->
    <div class="col-lg-2 d-none d-lg-block">
        <!-- Ad space placeholder -->
    </div>

    <!-- Main Content -->
    <div class="col-12 col-lg-8">
        <!-- Back to Book Link -->
        <div class="mb-3 d-flex justify-content-between align-items-center">
            <a href="{% url 'reader:section_book_detail' current_language.code book.bookmaster.section.slug book.slug %}"
               class="text-decoration-none">
                <i class="fas fa-arrow-left me-2"></i>
                <span class="fw-bold">{{ book.title }}</span>
            </a>

            <!-- Go to Top Button -->
            <button id="backToTop" class="btn btn-sm btn-outline-secondary" onclick="window.scrollTo({top: 0, behavior: 'smooth'})" style="display: none;">
                <i class="fas fa-arrow-up"></i> Top
            </button>
        </div>

        <!-- Chapter Header -->
        <div class="chapter-header d-flex justify-content-between align-items-start">
            <div class="chapter-header-title">
                <h1 class="display-6 mb-0">{{ chapter.title }}</h1>
            </div>
            <div class="chapter-header-stats">
                <span class="chapter-number">Chapter {{ chapter.chaptermaster.chapter_number }}</span>
                {% if chapter.published_at %}
                <span class="chapter-time">{{ chapter.published_at|naturaltime }}</span>
                {% endif %}
            </div>
        </div>

        <!-- Chapter Content -->
        <div class="chapter-content" id="chapter-content">
            {{ chapter.content|markdown }}
        </div>

        <!-- Chapter Navigation (Bottom) -->
        <div class="chapter-nav mt-5 pt-4">
            {% if next_chapter %}
            <div class="d-grid">
                {% if book.bookmaster.section %}
                    <a href="{% url 'reader:section_chapter_detail' current_language.code book.bookmaster.section.slug book.slug next_chapter.slug %}"
                       class="btn btn-primary-custom btn-lg">
                        Next Chapter
                    </a>
                {% else %}
                    <a href="{% url 'reader:chapter_detail' current_language.code book.slug next_chapter.slug %}"
                       class="btn btn-primary-custom btn-lg">
                        Next Chapter
                    </a>
                {% endif %}
                <div class="mt-2 text-center">
                    <small>{{ next_chapter.title|truncatechars:40 }}</small>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- End of Book Message -->
        {% if not next_chapter %}
        <div class="text-center mt-5 p-4 rounded">
            <h5 >ðŸŽ‰ You've reached the end!</h5>
            <p class="mb-3">Thanks for reading {{ book.title }}!</p>
            <a href="{% url 'reader:section_book_list' current_language.code book.bookmaster.section.slug %}"
               class="btn btn-primary-custom">
                Explore More {{ book.section_localized_name }} Books
            </a>
        </div>
        {% endif %}
    </div>

    <!-- Right Ad Space (for future use) -->
    <div class="col-lg-2 d-none d-lg-block">
        <!-- Ad space placeholder -->
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Load reading tracker library -->
{% load static %}
<script src="{% static 'reader/js/reading-tracker.js' %}"></script>

<script>
// Initialize reading progress tracking
document.addEventListener('DOMContentLoaded', function() {
    {% if view_event_id %}
    window.readingTracker.init(
        {{ view_event_id }},
        "{% url 'reader:reading_progress_api' %}",
        '#chapter-content'
    );
    {% else %}
    console.log('Reading tracking disabled: No view_event_id available');
    {% endif %}
});
</script>

<script>
// Reading History Tracker - Save to localStorage
(function() {
    // Save current reading progress to localStorage
    function saveReadingProgress() {
        const readingData = {
            bookId: {{ book.id }},
            bookTitle: "{{ book.title|escapejs }}",
            bookSlug: "{{ book.slug|escapejs }}",
            chapterId: {{ chapter.id }},
            chapterNumber: {{ chapter.chaptermaster.chapter_number }},
            chapterTitle: "{{ chapter.title|escapejs }}",
            chapterSlug: "{{ chapter.slug|escapejs }}",
            lastReadAt: new Date().toISOString(),
            coverImage: "{{ book.effective_cover_image|escapejs }}",
            languageCode: "{{ current_language.code|escapejs }}"
        };

        try {
            // Get existing reading history
            let readingHistory = JSON.parse(localStorage.getItem('readingHistory') || '[]');

            // Remove any existing entry for this book
            readingHistory = readingHistory.filter(item => item.bookId !== readingData.bookId);

            // Add current reading to the beginning
            readingHistory.unshift(readingData);

            // Keep only the most recent 20 books
            readingHistory = readingHistory.slice(0, 20);

            // Save back to localStorage
            localStorage.setItem('readingHistory', JSON.stringify(readingHistory));

            console.log('Reading progress saved:', readingData);
        } catch (error) {
            console.error('Failed to save reading progress:', error);
        }
    }

    // Save progress when page loads
    document.addEventListener('DOMContentLoaded', function() {
        saveReadingProgress();
    });

    // Optional: Update progress when user has been reading for a while
    let readingTimer = setTimeout(saveReadingProgress, 10000); // Update after 10 seconds

    // Clear timer on page unload
    window.addEventListener('beforeunload', function() {
        clearTimeout(readingTimer);
        saveReadingProgress(); // Final save before leaving
    });
})();

// Auto-scroll to content on mobile for better reading experience
document.addEventListener('DOMContentLoaded', function() {
    if (window.innerWidth <= 768) {
        const chapterContent = document.querySelector('.chapter-content');
        if (chapterContent) {
            chapterContent.scrollIntoView({
                behavior: 'smooth',
                block: 'start'
            });
        }
    }
});

// Reading progress bar - sync with navbar hide/show
(function() {
    const progressBar = document.getElementById('readingProgressBar');
    if (!progressBar) return;

    let lastScrollTop = 0;
    let scrollThreshold = 5;

    window.addEventListener('scroll', function() {
        // Calculate reading progress based on page scroll
        const windowHeight = window.innerHeight;
        const documentHeight = document.documentElement.scrollHeight;
        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;

        // Update progress bar width
        const scrollPercent = (scrollTop / (documentHeight - windowHeight)) * 100;
        progressBar.style.width = Math.min(100, Math.max(0, scrollPercent)) + '%';

        // Sync progress bar position with navbar visibility
        if (scrollTop <= 100) {
            progressBar.classList.remove('navbar-hidden');
        } else if (Math.abs(scrollTop - lastScrollTop) > scrollThreshold) {
            if (scrollTop > lastScrollTop) {
                // Scrolling down - hide with navbar
                progressBar.classList.add('navbar-hidden');
            } else {
                // Scrolling up - show with navbar
                progressBar.classList.remove('navbar-hidden');
            }
            lastScrollTop = scrollTop;
        }
    }, { passive: true });
})();

// Show/hide "Go to Top" button based on scroll position
(function() {
    const backToTop = document.getElementById('backToTop');
    if (!backToTop) return;

    window.addEventListener('scroll', function() {
        if (window.pageYOffset > 300) {
            backToTop.style.display = 'block';
        } else {
            backToTop.style.display = 'none';
        }
    }, { passive: true });
})();
</script>
{% endblock %}